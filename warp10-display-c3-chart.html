<!--
@author Horacio Gonzalez (@lostinbrittany)
@copyright (c) 2016 Cityzen Data
@license Apache 2.0
-->
<link rel="import" href=" ../polymer/polymer.html">

<link rel="import" href="./warp10-display-behavior.html">
<link rel="import" href="../granite-c3/granite-c3.html">

<dom-module id="warp10-display-chart">
  <template>
    <style>
      :host {
        display: block;
        width: 100%;
        height: 100%;
      }

      :host {
        display: inline-block;
        --fg-color: 'black';
        --bg-color: 'white'
      }

      granite-c3 {
        --c3-gauge-max-color: var(--fg-color);
        --c3-gauge-min-color: var(--fg-color);
        --c3-gauge-units-color: var(--fg-color);
        --c3-chart-arc text: var(--fg-color);
        display: inline-block;
      }

      .c3-chart-arcs .c3-chart-arcs-gauge-max, .c3-chart-arcs .c3-chart-arcs-gauge-min {
        fill: var(--fg-color);
      }

      .c3-chart-arc .c3-gauge-value {
        fill: --fg-color;
      }
    </style>
    <granite-c3
        color="[[chart.color]]"
        legend="[[chart.legend]]"
        line="[[chart.line]]"
        grid="[[chart.grid]]"
        padding="[[chart.padding]]"
        point="[[chart.point]]"
        tooltip="[[chart.tooltip]]"
        data="[[chart.data]]"
        axis="[[chart.axis]]"></granite-c3>
    <div id="chart"></div>
    <!--    <div class$="chart-tooltip {{_isTooltipHidden(tooltip)}}"></div>
        <div id="chart"></div>-->

  </template>
</dom-module>


<script>
  // element registration
  Polymer({
    is: 'warp10-display-chart',

    behaviors: [
      Warp10DisplayBehavior
    ],

    /**
     * Ready
     */
    ready: function() {
      // this.scopeSubtree(this.$.chart, true);
    },

    /**
     *
     */
    currentValuesChanged: function() {
      if (null !== this.isReady) {
        console.debug('[warp10-display-chart] currentValuesChanged() - currentValues', this.currentValues);
      }
    },
    /**
     *
     * @param oldValue
     * @param newValue
     */
    tooltipChanged: function(oldValue, newValue) {
    },
    /**
     *
     * @param tooltip
     * @returns {string}
     * @private
     */
    _isTooltipHidden: function(tooltip) {
      return 'hidden';
    },
    /**
     *
     * @private
     */
    _tooltipContent: function() {
    },

    /**
     *
     * @param gtsList
     * @returns {{xs: {}, types: {}, names: {}, colors: {}, columns: Array}}
     * @private
     */
    _gtsToC3Data: function(gtsList) {
      var data = {
        xs: {},
        types: {},
        names: {},
        colors: {},
        columns: [],
      };
      for (var i in gtsList) {
        var x = ['X' + i];
        var y = ['Y' + i];
        for (var j in gtsList[i].v) {
          var ts = gtsList[i].v[j][0];
          var value = gtsList[i].v[j][gtsList[i].v[j].length - 1];
          if (!this.timestamp) {
            ts = Math.round(ts / 1000);
          }
          x.push(ts);
          y.push(value)
        }
        data.xs['Y' + i] = 'X' + i;
        switch (this._params.interpolate[i]) {
          case 'linear':
            this._params.interpolate[i] = 'line';
            break;
          case 'step-before':
          case 'step-after':
            this._params.interpolate[i] = 'step';
            break;
          case 'cardinal':
            this._params.interpolate[i] = 'spline';
            break;
        }
        data.types['Y' + i] = this._params.interpolate[i];
        data.names['Y' + i] = this._params.labels[i];
        data.colors['Y' + i] = this._params.colors[i];
        data.columns.push(x);
        data.columns.push(y);
      }

      console.debug('[warp10-display-chart] _gtsToC3Data', data);
      return data;
    },

    /**
     *
     * @param filteredResponse
     * @private
     */
    _dataToChartLib: function(filteredResponse) {
      var data = this._gtsToC3Data(filteredResponse.gts);
      console.debug('[warp10-display-chart] _dataToChart - data', data);

      var point = {
        r: 0.5,
        focus: {
          expand: {
            enabled: true,
            r: 4,
          }
        }
      };

      var line = {
        step: {
          type: 'step-before'
        }
      };
      var axis = {
        x: {
          tick: {}
        },
        y: {},
      };
      if (this.hideAxis) {
        axis.x.show = false;
        axis.y.show = false;

      } else {
        axis.x.show = true;
        axis.y.show = true

        axis.x.tick = {
          centered: true,
          count: 5,
          outer: false,
          fit: true
        };
        if (this.timestamps) {
          axis.x.type = 'indexed';

          axis.x.format = function(y) {
            var value = y.toFixed(5);
            var splittedValue = value.split('.');
            var formattedIntPart = splittedValue[0].replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,');
            var formattedDecimalPart = splittedValue[1].replace(/0+$/g, '');
            if (formattedDecimalPart.length === 0) {
              return formattedIntPart;
            }
            return formattedIntPart + '.' + formattedDecimalPart;
          }
        } else {
          axis.x.type = 'timeseries';
          axis.x.tick.format = '%Y-%m-%d %H:%M:%S'
        }
        axis.y.tick = {
          centered: true,
          outer: false,
          fit: true,
          format: function(y) {
            var value = y.toFixed(5);
            var splittedValue = value.split('.');
            var formattedIntPart = splittedValue[0].replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1,');
            var formattedDecimalPart = splittedValue[1].replace(/0+$/g, '');
            if (formattedDecimalPart.length === 0) {
              return formattedIntPart;
            }
            return formattedIntPart + '.' + formattedDecimalPart;
          }
        };
      }
      var legend = {
        hide: true,
      };
      var padding = {
        right: 30
      };
      var tooltip = {
        format: {},
        grouped: false // Default true
      };
      var grid = {
        x: {
          show: true
        },
        y: {
          show: true
        },
      };

      var c3Data = {
        data: data,
        axis: axis,
        legend: legend,
        point: point,
        padding: padding,
        line: line,
        tooltip: tooltip,
        grid: grid,
      };
      console.debug('[warp10-display-chart] _dataToChart - c3Data', c3Data);
      this.chart = c3Data;
    }
  });


</script>
