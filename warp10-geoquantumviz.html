<link rel="import" href=" ../polymer/polymer.html">
<link rel="import" href=" ../iron-ajax/iron-ajax.html">
<link   rel="import" href="../warp10-quantumviz/warp10-quantumviz.html">
<link   rel="import" href=" ../leaflet-map/leaflet-map.html">
<dom-module name="warp10-geoquantumviz" >
  <style>
    :host {
      display: block;
    }
  	leaflet-map {
      max-width: 100%;
      width: 100%;
      height: 400px;
      border: 1px solid #aaa;
  	}
    /deep/ .leaflet-control-attribution {
      display: none;
    }
  </style>
  <template>

    <leaflet-map id="map" latitude="51.505" longitude="-0.09" zoom="13">
    </leaflet-map>

    <warp10-quantumviz
      width="{{width}}" height="{{height}}"
      show-axis="{{showAxis}}"  tooltip="{{tooltip}}"
      line-width="{{lineWidth}}" reload="{{reload}}"
      current-values="{{currentValues}}" host="{{host}}"
      content="{{content}}" data="{{data}}"
      >
    </warp10-quantumviz>

  </template>
</dom-module>

  <script>
    // element registration
    Polymer({
      is: "warp10-geoquantumviz",
      properties: {
          width: {
            type: Number,
            value: -1
          },
          height: {
            type: Number,
            value: -1
          },
          host: {
            type: String,
            value: ""
          },
          showAxis: {
            type: String,
            value: "true"
          },
          tooltip: {
            type: String,
            value: "true"
          },
          lineWidth: {
            type: Number,
            value: 2
          },
          reload: {
            type: Number,
            value: -1
          },
          currentValues: {
            type: Object,
            observer: 'currentValuesChanged',
            notify: true
          },
          data: {
            type: Object,
            observer: 'dataChanged',
            notify: true
          }
      },
      ready: function() {
        this.content = Polymer.dom(this).innerHTML.replace(/&lt;/g,'<').replace(/&gt;/g,'>');
        this.polylinesBeforeCurrentValue = [];
        this.polylinesAfterCurrentValue = [];
        this.currentValuesMarkers = [];
      },
      dataChanged: function() {
        this.pathData = quantumvizGts.toLeafletMapPaths(this.data);
        console.log("Data changed", this.pathData);
        var map = this.$.map.map

        var circleRadius = map.getBounds().getSouthWest().distanceTo(map.getBounds().getNorthEast())/30;

        // Create the polylines and the circle marker
        for (var i=0; i< this.pathData.length; i++) {
          this.polylinesBeforeCurrentValue.push(L.polyline(quantumvizGts.pathDataToLeaflet(this.pathData[i].path, {to:0}), {color: this.pathData[i].color, opacity: 1} ).addTo(map));
          this.polylinesAfterCurrentValue.push(L.polyline(quantumvizGts.pathDataToLeaflet(this.pathData[i].path, {from:0}), {color: this.pathData[i].color, opacity: 0.5} ).addTo(map));

          //Let's verify we have a path... No poth, no marker
          if (this.pathData[i].path[0] !== undefined ) {
            var circle = L.circleMarker([this.pathData[i].path[0].lat, this.pathData[i].path[0].lon],
              {radius: 5, color:  "#fff", fillColor:  this.pathData[i].color, fillOpacity: 1}).addTo(map);
            this.currentValuesMarkers.push(circle);
          } else {
            this.currentValuesMarkers.push(L.circleMarker());
          }
        }

        // Fit map to curves
        map.fitBounds(quantumvizGts.getBoundsArray(this.pathData));

      },
      currentValuesChanged: function() {
        var map = this.$.map.map
        // All works on seconds only now...
        //console.log("Current time "+ this.currentValues.xValue + " - "+ new Date(this.currentValues.xValue) + " - " + (new Date(this.currentValues.xValue)).getTime() )
        var currentTS = Math.floor( (new Date(this.currentValues.xValue)).getTime() / 1000 );

        for (var i=0; i< this.pathData.length; i++) {
          for (var j=0; j<this.pathData[i].path.length; j++) {
            //console.log("Do they match? "+currentTS+ " - "+this.pathData[i].path[j].ts)
            if (currentTS <= Math.floor( this.pathData[i].path[j].ts / 1000 )) {
              this.currentValuesMarkers[i].setLatLng([this.pathData[i].path[j].lat, this.pathData[i].path[j].lon]);
              this.polylinesBeforeCurrentValue[i].setLatLngs(quantumvizGts.pathDataToLeaflet(this.pathData[i].path, {to:j}));
              this.polylinesAfterCurrentValue[i].setLatLngs(quantumvizGts.pathDataToLeaflet(this.pathData[i].path, {from:j}));
              break;
            }
          }
        }
      }
    });
  </script>
